<!DOCTYPE html>
<!-- Déclaration du type de document et de la langue principale (Français) pour l'accessibilité et le SEO. -->
<html lang="fr">
<head>
    <!-- Méta-informations essentielles pour le navigateur et les moteurs de recherche. -->
    <meta charset="UTF-8"> <!-- Spécifie l'encodage des caractères en UTF-8 pour une compatibilité maximale. -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Assure un affichage responsive sur les appareils mobiles. -->
    <title>Numérologie Stratégique - Grand Maître</title> <!-- Titre affiché dans l'onglet du navigateur. -->
    
    <!-- Pré-connexion aux serveurs de Google Fonts pour un chargement plus rapide des polices. -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Importation des polices personnalisées 'Lora' (serif, pour les titres) et 'Poppins' (sans-serif, pour le corps du texte). -->
    <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- Section des styles CSS pour la mise en page et l'apparence de l'application. -->
    <style>
        /*
         * DÉFINITION DES VARIABLES CSS (CUSTOM PROPERTIES)
         * L'utilisation de variables permet une gestion centralisée des couleurs et des styles.
         * Changer une variable ici met à jour toute l'application, facilitant la maintenance et le theming (mode clair/sombre).
        */
        :root {
            /* Palette de couleurs principale (Thème Clair) */
            --primary-color: #3a0ca3;         /* Couleur principale pour les titres et les accents forts. */
            --secondary-color: #7209b7;       /* Couleur secondaire pour les cercles de nombres et les dégradés. */
            --background-color: #f5f3f4;      /* Couleur de fond générale de la page. */
            --text-color: #212529;            /* Couleur du texte par défaut pour une bonne lisibilité. */
            --card-bg: #ffffff;               /* Couleur de fond des cartes de contenu. */
            --border-radius: 12px;            /* Rayon de bordure standard pour un look moderne et doux. */
            --box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08); /* Ombre portée pour donner de la profondeur aux éléments. */
            
            /* Couleurs spécifiques pour des composants UI */
            --summary-border: #4361ee;        /* Couleur de la bordure pour la carte de synthèse. */
            --karmic-bg: #fffbe6;             /* Fond pour les avertissements karmiques. */
            --karmic-border: #ffc107;         /* Bordure pour les avertissements karmiques. */
            --daily-vibration-bg: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%); /* Dégradé pour la vibration du jour. */

            /* Couleurs pour l'analyse de compatibilité */
            --harmony-color: #2a9d8f;         /* Vert pour les relations harmonieuses. */
            --challenge-color: #e76f51;       /* Orange/Rouge pour les relations de défi. */
            --neutral-color: #f4a261;         /* Jaune/Orange pour les relations neutres. */
        }

        /* Redéfinition des variables pour le mode sombre (dark-mode) */
        body.dark-mode {
            --primary-color: #9d4edd;
            --secondary-color: #c77dff;
            --background-color: #121212; /* Un noir profond mais pas absolu pour un meilleur confort visuel. */
            --text-color: #e0e0e0;       /* Un gris clair pour le texte, moins agressif que le blanc pur. */
            --card-bg: #1e1e1e;           /* Un gris foncé pour les cartes, créant un contraste subtil. */
            --box-shadow: 0 6px 20px rgba(255, 255, 255, 0.05);
            --summary-border: #80ffdb;
            --karmic-bg: #332b00;
            --karmic-border: #ffc107;
            --daily-vibration-bg: linear-gradient(135deg, #2d1a3c 0%, #2c3e50 100%);
            --harmony-color: #80ffdb;
            --challenge-color: #ff9b85;
            --neutral-color: #ffcb77;
        }

        /* Animation d'apparition subtile pour les éléments de contenu. */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* STYLES GÉNÉRAUX */
        html { scroll-behavior: smooth; } /* Permet un défilement fluide lors des clics sur les ancres. */
        body {
            font-family: 'Poppins', sans-serif; /* Police par défaut pour le corps du texte. */
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex; /* Utilisation de flexbox pour centrer le conteneur principal. */
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s; /* Transition douce pour le changement de thème. */
        }
        .container { max-width: 800px; width: 100%; }

        /* STRUCTURE & MISE EN PAGE */
        header { text-align: center; margin-bottom: 20px; color: var(--primary-color); position: relative; }
        header h1 { font-family: 'Lora', serif; font-size: 2.5em; font-weight: 600; margin: 0; }
        
        /* Navigation par onglets (Mon Thème / Compatibilité) */
        nav.app-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 15px;}
        nav.app-nav button { padding: 10px 20px; font-size: 1em; background: transparent; color: var(--text-color); border: 2px solid transparent; border-radius: var(--border-radius); font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        nav.app-nav button.active { /* Style pour l'onglet actif */
            color: var(--primary-color); 
            border-bottom: 2px solid var(--primary-color);
            background-color: color-mix(in srgb, var(--primary-color) 10%, transparent); /* Fond subtil pour l'onglet actif. */
        }
        
        /* Gestion de l'affichage des onglets */
        .tab-content { display: none; } /* Par défaut, les contenus des onglets sont cachés. */
        .tab-content.active { display: block; animation: fadeIn 0.5s; } /* L'onglet actif est affiché avec une animation. */
        
        main { background: var(--card-bg); padding: 30px 40px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); transition: background-color 0.3s; }
        #welcome-back { padding: 15px; background-color: color-mix(in srgb, var(--summary-border) 20%, transparent); border: 1px solid var(--summary-border); color: var(--text-color); border-radius: var(--border-radius); margin-bottom: 20px; text-align: center; font-weight: 600; }
        .interpretation-details ul { padding-left: 20px; }
        .interpretation-details li { margin-bottom: 8px; }
        
        /* FORMULAIRES & BOUTONS */
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary-color); }
        .input-group input { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: var(--border-radius); 
            font-size: 1em; font-family: 'Poppins', sans-serif; box-sizing: border-box; /* Essentiel pour que le padding n'affecte pas la largeur totale. */
            background-color: var(--card-bg); color: var(--text-color); 
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        button { 
            width: 100%; padding: 15px; 
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
            color: white; border: none; border-radius: var(--border-radius);
            font-size: 1.2em; font-weight: 600; cursor: pointer; transition: all 0.2s; 
        }
        button:hover:not(:disabled) { /* Effet de survol pour les boutons actifs */
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px rgba(58, 12, 163, 0.4); 
        }
        button:disabled { background: #999; cursor: not-allowed; transform: translateY(0); box-shadow: none; }

        /* CARTES DE RÉSULTATS */
        .card { 
            opacity: 0; /* Initialement invisible pour l'animation d'apparition. */
            background-color: var(--card-bg); padding: 25px; margin-bottom: 25px; 
            border-radius: var(--border-radius); border-left: 6px solid var(--secondary-color); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
        }
        .card.fade-in { animation: fadeIn 0.5s ease-out forwards; } /* 'forwards' maintient l'état final de l'animation. */
        h2 { margin-top: 0; margin-bottom: 15px; color: var(--primary-color); display: flex; align-items: center; font-family: 'Lora', serif; font-size: 1.8em; }

        /* CERCLE DE NOMBRE (Élément visuel central) */
        .number-circle {
            flex-shrink: 0; /* Empêche le cercle de se réduire si le titre est trop long. */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            width: 70px; height: 70px; background-color: var(--secondary-color); color: white; border-radius: 50%;
            font-weight: 700; margin-right: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            cursor: pointer; transition: transform 0.2s; box-sizing: border-box;
            font-size: 2.5em; /* Taille par défaut pour les nombres à un chiffre. */
        }
        .number-circle:hover { transform: scale(1.1); } /* Agrandissement au survol. */
        /* Styles spécifiques pour les Maîtres Nombres (ex: 22/4) */
        .number-circle .master-part { font-size: 1.7rem; line-height: 1.1; }
        .number-circle .separator { width: 65%; margin: 2px 0; border: none; border-top: 2px solid rgba(255, 255, 255, 0.75); }
        .number-circle .base-part { font-size: 1.4rem; line-height: 1; opacity: 0.9; }

        /* STYLES SPÉCIFIQUES DES COMPOSANTS */
        .daily-vibration-card { border: none; background: var(--daily-vibration-bg); color: #fff; }
        .daily-vibration-card h2, .daily-vibration-card .description, body.dark-mode .daily-vibration-card p { color: #fff; } /* Assure la lisibilité du texte sur le fond dégradé. */
        
        .karmic-warning { background-color: var(--karmic-bg); border: 1px solid var(--karmic-border); border-radius: var(--border-radius); padding: 15px; margin-top: 20px; color: color-mix(in srgb, var(--karmic-border) 80%, #000 20%);}
        .methodology-note { font-size: 0.8em; opacity: 0.7; margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee; }
        
        .action-buttons { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
        .action-buttons button { flex: 1 1 200px; } /* Les boutons s'adaptent à la largeur disponible. */
        .ai-prompt-description { font-size: 0.85em; opacity: 0.8; margin: 8px 0 0 0; text-align: center; color: var(--text-color); width: 100%; }

        /* MODALE (POP-UP) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.3s; }
        .modal-content { background-color: var(--card-bg); margin: 10% auto; padding: 30px; border-top: 5px solid var(--primary-color); width: 80%; max-width: 600px; border-radius: var(--border-radius); position: relative; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .hidden { display: none !important; } /* Classe utilitaire pour cacher des éléments. */

        /* INTERRUPTEUR DE THÈME (THEME SWITCHER) */
        .theme-switch-wrapper { display: flex; align-items: center; position: absolute; top: 15px; right: 15px; }
        .theme-switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* STYLES POUR LA PAGE DE COMPATIBILITÉ */
        #compatibility-results .card { border-left-width: 6px; }
        #compatibility-results .card.harmony { border-left-color: var(--harmony-color); }
        #compatibility-results .card.challenge { border-left-color: var(--challenge-color); }
        #compatibility-results .card.neutral { border-left-color: var(--neutral-color); }
        
        /* GRAPHIQUE DES ÉNERGIES & CYCLES DE VIE */
        .energy-chart-svg-container { margin-top: 15px; }
        .energy-analysis { margin-top: 15px; padding: 15px; background-color: color-mix(in srgb, var(--primary-color) 5%, transparent); border-radius: var(--border-radius); }
        .life-cycles-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; } /* Grille responsive pour les cycles de vie. */
        .cycle-card { padding: 15px; border-radius: var(--border-radius); background-color: color-mix(in srgb, var(--primary-color) 5%, transparent); text-align: center; }
        .cycle-card h3 { font-family: 'Lora', serif; color: var(--primary-color); margin-top: 0; }
        
        footer a { color: var(--primary-color); text-decoration: none; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>
    <!-- Le conteneur principal qui centre le contenu sur la page. -->
    <div class="container">
        
        <!-- En-tête de l'application avec le titre principal et le sélecteur de thème. -->
        <header>
            <h1>🔮 Numérologie - Grand Maître</h1>
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="theme-toggle"><input type="checkbox" id="theme-toggle" /><span class="slider round"></span></label>
            </div>
        </header>
        
        <!-- Barre de navigation principale pour basculer entre les sections de l'application. -->
        <nav class="app-nav">
            <button id="nav-theme" class="active">Mon Thème</button>
            <button id="nav-compatibility">Compatibilité</button>
        </nav>

        <!-- Contenu principal de l'application. -->
        <main>
            <!-- Onglet 1 : Calcul du thème personnel. Il est actif par défaut. -->
            <div id="theme-content" class="tab-content active">
                <!-- Message de bienvenue pour les utilisateurs récurrents, caché par défaut. -->
                <div id="welcome-back" class="hidden"></div>

                <!-- Formulaire pour entrer les données de l'utilisateur. -->
                <form id="numerology-form">
                    <div class="input-group"><label for="full-name">Vos Noms & Prénoms (de naissance)</label><input type="text" id="full-name" required></div>
                    <div class="input-group">
                        <label for="birth-date">Votre Date de naissance</label>
                        <input type="text" id="birth-date" required placeholder="JJ/MM/AAAA" inputmode="numeric" pattern="\d{2}/\d{2}/\d{4}">
                    </div>
                    <button type="submit">Calculer mon Thème Complet</button>
                </form>

                <!-- Conteneur pour tous les résultats, initialement caché. -->
                <div id="results-wrapper" class="hidden">
                    <div id="daily-vibration-container"></div> <!-- Pour la vibration du jour. -->
                    <div id="summary-container"></div>         <!-- Pour la synthèse stratégique. -->
                    <div id="results-container"></div>         <!-- Pour les nombres principaux. -->
                    <div id="energy-presence-container"></div>  <!-- Pour le graphique des énergies. -->
                    <div id="life-cycles-container"></div>      <!-- Pour les cycles de vie. -->
                    <!-- Conteneur pour la carte de profil générée, cachée par défaut. -->
                    <div id="profile-card-container" class="hidden"><h2>🖼️ Votre Carte de Profil</h2><p>Faites un clic droit sur l'image pour la sauvegarder.</p><canvas id="profile-card-canvas"></canvas></div>
                    <!-- Boutons d'action pour exporter, imprimer, etc. -->
                    <div class="action-buttons">
                        <button id="ai-export-btn">✨ Analyser avec une IA</button>
                        <button id="profile-card-btn">🖼️ Créer ma Carte</button>
                        <button id="print-btn">🖨️ Imprimer / PDF</button>
                    </div>
                </div>
            </div>

            <!-- Onglet 2 : Calculateur de compatibilité, caché par défaut. -->
            <div id="compatibility-content" class="tab-content">
                <h2>Analyse de Compatibilité</h2>
                <p>Comparez votre thème avec celui d'une autre personne pour découvrir vos dynamiques relationnelles.</p>
                <form id="compatibility-form">
                    <h4>Personne 1 (Vous)</h4>
                    <div class="input-group"><label for="p1-full-name">Noms & Prénoms</label><input type="text" id="p1-full-name" required></div>
                    <div class="input-group"><label for="p1-birth-date">Date de naissance</label><input type="text" id="p1-birth-date" required placeholder="JJ/MM/AAAA" inputmode="numeric" pattern="\d{2}/\d{2}/\d{4}"></div>
                    <hr>
                    <h4>Personne 2</h4>
                    <div class="input-group"><label for="p2-full-name">Noms & Prénoms</label><input type="text" id="p2-full-name" required></div>
                    <div class="input-group"><label for="p2-birth-date">Date de naissance</label><input type="text" id="p2-birth-date" required placeholder="JJ/MM/AAAA" inputmode="numeric" pattern="\d{2}/\d{2}/\d{4}"></div>
                    <button type="submit">Analyser la Compatibilité</button>
                </form>
                <!-- Conteneur pour les résultats de compatibilité, initialement caché. -->
                <div id="compatibility-results" class="hidden"></div>
            </div>
        </main>

        <!-- Pied de page avec des informations et des liens. -->
        <footer style="text-align:center; font-size: 0.9em; opacity: 0.7; padding: 20px 0;">
            <p>Application créée pour la découverte de soi. Ne remplace pas un conseil professionnel.</p>
            <p><a id="methodology-link">Notre Méthodologie de Calcul</a></p>
        </footer>
    </div>
    
    <!-- Fenêtres modales (pop-ups) pour le glossaire et la méthodologie, cachées par défaut. -->
    <div id="glossary-modal" class="modal"><div class="modal-content"><span id="modal-close-btn" class="close-button">×</span><div id="modal-body"></div></div></div>
    <div id="methodology-modal" class="modal"><div class="modal-content"><span id="methodology-close-btn" class="close-button">×</span><div id="methodology-modal-body"></div></div></div>
    
    <!-- ========================================================================================= -->
    <!--                                    SCRIPT JAVASCRIPT                                      -->
    <!-- Toute la logique de l'application est contenue ici.                                       -->
    <!-- ========================================================================================= -->
    <script>
        // L'écouteur d'événement 'DOMContentLoaded' s'assure que le script ne s'exécute qu'après le chargement complet du HTML.
        document.addEventListener('DOMContentLoaded', () => {

            // ========================== OBJET `data` ==========================
            // Cet objet agit comme une mini-base de données. Il centralise toutes les informations statiques
            // (valeurs des lettres, interprétations, etc.) pour une maintenance et une lisibilité faciles.
            const data = {
                // Correspondance des lettres à leur valeur numérique (système pythagoricien).
                letterValues: { 'A':1,'J':1,'S':1, 'B':2,'K':2,'T':2, 'C':3,'L':3,'U':3, 'D':4,'M':4,'V':4, 'E':5,'N':5,'W':5, 'F':6,'O':6,'X':6, 'G':7,'P':7,'Y':7, 'H':8,'Q':8,'Z':8, 'I':9,'R':9 },
                vowels: ['A', 'E', 'I', 'O', 'U', 'Y'], // La lettre 'Y' est traitée comme une voyelle pour le Nombre de l'Âme.
                masterNumbers: [11, 22, 33], // Nombres Maîtres qui ne sont pas réduits à un seul chiffre.
                // Mappage des dettes karmiques à leur signification.
                karmicDebtsMap: { 13: "la paresse et le travail", 14: "les abus des sens et l'instabilité", 16: "l'orgueil et la destruction de l'ego", 19: "l'égoïsme et l'abus de pouvoir" },
                // Mots-clés pour chaque énergie, utilisés dans le glossaire et l'analyse.
                energyKeywords: { 1: "Leader", 2: "Diplomate", 3: "Créatif", 4: "Bâtisseur", 5: "Aventurier", 6: "Responsable", 7: "Sage", 8: "Puissant", 9: "Humaniste", 11: "Inspiré", 22: "Grand Bâtisseur", 33: "Guide" },
                // Texte explicatif pour la modale de méthodologie.
                methodologyText: {
                    title: "Notre Approche & Méthodologie de Calcul",
                    content: `<p>Cette application s'inspire de la <strong>numérologie stratégique</strong>, une approche moderne qui vise à fournir des clés de compréhension de soi actionnables. Voici les principes de calcul utilisés :</p>
                    <ul>
                        <li><strong>Réduction des nombres :</strong> Tous les nombres sont réduits à un seul chiffre (de 1 à 9), sauf les <strong>Maîtres Nombres 11, 22 et 33</strong>, qui conservent leur propre vibration. L'application affiche ces nombres avec leur base (ex: 22/4) pour une analyse complète.</li>
                        <li><strong>Nombre de l'Âme (Élan Spirituel) :</strong> Il est calculé en additionnant la valeur de toutes les voyelles de vos noms et prénoms de naissance. Conformément à une convention répandue, la lettre <strong>'Y' est systématiquement considérée comme une voyelle</strong> dans nos calculs. Des écoles différentes peuvent la traiter comme une consonne dans certains cas, ce qui peut expliquer des variations de résultats.</li>
                        <li><strong>Nombre de Personnalité (Moi Intime) :</strong> Il est obtenu par la somme des consonnes de vos noms et prénoms.</li>
                        <li><strong>Nombre d'Expression (Potentiel) :</strong> Il est la somme de toutes les lettres (voyelles + consonnes).</li>
                        <li><strong>Dettes Karmiques :</strong> Nous identifions les dettes karmiques (13, 14, 16, 19) lorsqu'elles apparaissent comme résultat intermédiaire avant la réduction finale dans les nombres principaux. Elles représentent des défis spécifiques à intégrer.</li>
                    </ul>
                    <p>La numérologie est un outil de réflexion. Différentes approches (évolutive, karmique, etc.) peuvent utiliser des variantes de calcul. Cet outil vous offre une base solide issue d'une méthode reconnue pour commencer votre exploration.</p>`
                },
                
                // ==================================================================
                // NOUVELLES INTERPRÉTATIONS DÉTAILLÉES
                // ==================================================================
                interpretations: {
                    cheminDeVie: {
                        1: `<strong>Le Pionnier Indépendant :</strong> Votre mission de vie est de développer votre individualité, votre courage et votre capacité à initier. C'est un chemin qui vous demande de croire en vous, de prendre les devants et d'innover sans attendre l'approbation des autres.
                            <div class="interpretation-details">
                                <p><strong>Vos forces sur ce chemin :</strong></p>
                                <ul><li>Leadership naturel et ambition.</li><li>Originalité et créativité pour trouver de nouvelles solutions.</li><li>Force de caractère et détermination.</li></ul>
                                <p><strong>Les défis à maîtriser :</strong></p>
                                <ul><li>L'impatience et la tendance à l'autoritarisme.</li><li>La peur de la solitude ou, à l'inverse, un isolement excessif.</li><li>Apprendre à collaborer et à écouter les idées des autres.</li></ul>
                                <p><strong>Votre clé d'évolution :</strong> Incarnez le leader inspirant, pas le tyran. Votre véritable force se révèle lorsque vous utilisez votre énergie pour ouvrir la voie, non seulement pour vous-même mais aussi pour les autres.</p>
                            </div>`,
                        2: `<strong>Le Diplomate Coopératif :</strong> Votre mission est d'apprendre l'art de la collaboration, de l'harmonie et de la diplomatie. C'est un chemin qui vous invite à développer votre patience, votre écoute et votre capacité à unir les gens et les idées, en trouvant l'équilibre et la paix.
                            <div class="interpretation-details">
                                <p><strong>Vos forces sur ce chemin :</strong></p>
                                <ul><li>Grande sensibilité et intuition pour comprendre les autres.</li><li>Capacité à être un médiateur et un partenaire loyal.</li><li>Patience et sens du détail.</li></ul>
                                <p><strong>Les défis à maîtriser :</strong></p>
                                <ul><li>L'indécision et la dépendance à l'opinion d'autrui.</li><li>Une trop grande sensibilité qui peut mener à être facilement blessé.</li><li>La difficulté à dire non et à s'affirmer.</li></ul>
                                <p><strong>Votre clé d'évolution :</strong> Trouvez votre force dans la douceur. Votre pouvoir ne réside pas dans la confrontation, mais dans votre capacité à créer des ponts. Apprenez à vous affirmer avec calme et à faire confiance à votre propre jugement.</p>
                            </div>`,
                        3: `<strong>Le Communicant Créatif :</strong> Votre mission est d'exprimer votre créativité, votre joie de vivre et d'inspirer les autres par la communication. C'est un chemin d'expression de soi, que ce soit par l'art, l'écriture, la parole ou simplement par votre optimisme contagieux.
                            <div class="interpretation-details">
                                <p><strong>Vos forces sur ce chemin :</strong></p>
                                <ul><li>Imagination fertile et grand talent artistique.</li><li>Excellent communicant, sociable et charismatique.</li><li>Optimisme et enthousiasme naturels.</li></ul>
                                <p><strong>Les défis à maîtriser :</strong></p>
                                <ul><li>La dispersion et la difficulté à terminer ce que vous commencez.</li><li>La superficialité ou la peur d'aborder les émotions profondes.</li><li>La sensibilité à la critique.</li></ul>
                                <p><strong>Votre clé d'évolution :</strong> Canalisez votre énergie créatrice. Choisissez un ou deux domaines qui vous passionnent et engagez-vous à les approfondir. Votre joie est votre guide, mais la discipline est le véhicule qui la transformera en réalisations durables.</p>
                            </div>`,
                        4: `<strong>Le Bâtisseur Structuré :</strong> Votre mission est de construire des fondations solides et durables, d'apporter de l'ordre, de la stabilité et de la sécurité. C'est un chemin qui demande du travail, de la discipline, de la patience et un grand sens de l'organisation.
                            <div class="interpretation-details">
                                <p><strong>Vos forces sur ce chemin :</strong></p>
                                <ul><li>Fiabilité, persévérance et grand sens du travail.</li><li>Capacité à planifier, organiser et gérer les détails.</li><li>Honnêteté et intégrité.</li></ul>
                                <p><strong>Les défis à maîtriser :</strong></p>
                                <ul><li>La rigidité et la résistance au changement.</li><li>Une tendance à être trop prudent ou à voir les limites avant les opportunités.</li><li>Le surmenage et la difficulté à déléguer.</li></ul>
                                <p><strong>Votre clé d'évolution :</strong> Apprenez la flexibilité. Votre capacité à construire est immense, mais elle devient une force inarrêtable lorsque vous acceptez que les plans peuvent changer. La vraie sécurité vient de votre capacité à vous adapter, pas seulement de votre capacité à contrôler.</p>
                            </div>`,
                        5: `<strong>L'Aventurier Libre :</strong> Votre mission est d'expérimenter la liberté à travers le changement, le mouvement et la diversité. C'est un chemin d'adaptation, d'exploration et d'expériences multiples qui vous demande d'embrasser l'inconnu et de vivre pleinement le moment présent.
                            <div class="interpretation-details">
                                <p><strong>Vos forces sur ce chemin :</strong></p>
                                <ul><li>Grande capacité d'adaptation et polyvalence.</li><li>Curiosité, esprit aventureux et amour de la nouveauté.</li><li>Charisme et talent pour la communication.</li></ul>
                                <p><strong>Les défis à maîtriser :</strong></p>
                                <ul><li>L'instabilité et la peur de l'engagement.</li><li>La tendance à la dispersion et à l'excès sous toutes ses formes.</li><li>L'impatience et un sentiment d'insatisfaction chronique.</li></ul>
                                <p><strong>Votre clé d'évolution :</strong> La liberté disciplinée. Votre soif d'expérience est un don, mais elle trouve son plein potentiel lorsque vous apprenez à choisir vos aventures et à vous y consacrer. La vraie liberté n'est pas l'absence de contraintes, mais le choix conscient de celles-ci.</p>
                            </div>`,
                        6: `<strong>Le Responsable Harmonieux :</strong> Votre mission est de cultiver l'harmonie, l'amour et le sens des responsabilités, notamment au sein de la famille, du foyer et de la communauté. C'est un chemin de service, de conseil et de guérison, où vous apprenez à donner et à recevoir avec équilibre.
                            <div class="interpretation-details">
                                <p><strong>Vos forces sur ce chemin :</strong></p>
                                <ul><li>Générosité, bienveillance et sens de la protection.</li><li>Capacité à créer de la beauté et de l'harmonie.</li><li>Fiabilité et grand sens du devoir.</li></ul>
                                <p><strong>Les défis à maîtriser :</strong></p>
                                <ul><li>La tendance au sacrifice et à s'oublier pour les autres.</li><li>Le perfectionnisme et le besoin de tout contrôler.</li><li>L'ingérence dans la vie d'autrui, en pensant savoir ce qui est bon pour eux.</li></ul>
                                <p><strong>Votre clé d'évolution :</strong> L'amour équilibré. Apprenez à prendre soin de vous avec la même dévotion que vous prenez soin des autres. Votre responsabilité première est envers votre propre bien-être, car on ne peut verser d'une carafe vide.</p>
                            </div>`,
                        7: `<strong>Le Sage Introspectif :</strong> Votre mission est la quête de la connaissance, de la vérité et de la sagesse. C'est un chemin d'introspection, d'analyse et de connexion spirituelle, qui vous demande de regarder au-delà des apparences pour comprendre les mystères de la vie.
                            <div class="interpretation-details">
                                <p><strong>Vos forces sur ce chemin :</strong></p>
                                <ul><li>Esprit d'analyse aiguisé et grande capacité de recherche.</li><li>Intuition et perception profonde des choses.</li><li>Calme, observation et besoin de solitude pour se ressourcer.</li></ul>
                                <p><strong>Les défis à maîtriser :</strong></p>
                                <ul><li>L'isolement et la difficulté à partager ses émotions.</li><li>Le cynisme ou le scepticisme excessif.</li><li>Une tendance à trop intellectualiser et à se couper du corps et du cœur.</li></ul>
                                <p><strong>Votre clé d'évolution :</strong> La sagesse partagée. Votre quête intérieure prend tout son sens lorsque vous trouvez un moyen de transmettre ce que vous avez appris. La foi, non pas nécessairement religieuse mais en la vie elle-même, est le pont entre votre monde intérieur et le monde extérieur.</p>
                            </div>`,
                        8: `<strong>Le Maître Ambitieux :</strong> Votre mission est de maîtriser le monde matériel, le pouvoir et l'abondance. C'est un chemin qui vous demande de développer votre ambition, votre autorité et votre capacité à gérer de grands projets, tout en apprenant à utiliser ce pouvoir avec éthique et générosité.
                            <div class="interpretation-details">
                                <p><strong>Vos forces sur ce chemin :</strong></p>
                                <ul><li>Ambition, persévérance et vision stratégique.</li><li>Grande capacité de travail et d'organisation.</li><li>Charisme, autorité naturelle et sens de la justice.</li></ul>
                                <p><strong>Les défis à maîtriser :</strong></p>
                                <ul><li>L'autoritarisme et une focalisation excessive sur l'argent et le pouvoir.</li><li>L'impatience et une attitude "tout ou rien".</li><li>La difficulté à exprimer sa vulnérabilité et ses émotions.</li></ul>
                                <p><strong>Votre clé d'évolution :</strong> Le pouvoir au service des autres. Votre véritable maîtrise s'accomplit lorsque votre succès personnel contribue également au bien-être collectif. L'équilibre entre le matériel et le spirituel est la clé de votre épanouissement.</p>
                            </div>`,
                        9: `<strong>L'Humaniste Altruiste :</strong> Votre mission est de développer la compassion, la tolérance et une vision universelle. C'est un chemin d'ouverture au monde, de service à l'humanité et d'accomplissement de grandes causes, qui vous demande d'apprendre à donner sans rien attendre en retour et à lâcher prise.
                            <div class="interpretation-details">
                                <p><strong>Vos forces sur ce chemin :</strong></p>
                                <ul><li>Grande générosité, altruisme et sensibilité.</li><li>Idéalisme et capacité à inspirer les autres.</li><li>Ouverture d'esprit et vision large des choses.</li></ul>
                                <p><strong>Les défis à maîtriser :</strong></p>
                                <ul><li>Une émotivité intense et la difficulté à gérer ses propres besoins.</li><li>La tendance à vivre dans le passé et à ne pas pardonner (à soi ou aux autres).</li><li>Le désenchantement face aux dures réalités du monde.</li></ul>
                                <p><strong>Votre clé d'évolution :</strong> L'accomplissement et le lâcher-prise. Votre chemin culmine dans la finalisation des cycles. Apprenez à terminer ce que vous avez commencé, à pardonner et à laisser partir ce qui ne vous sert plus. Votre sagesse réside dans votre capacité à aimer le monde tel qu'il est, tout en œuvrant pour le rendre meilleur.</p>
                            </div>`,
                        11: `<strong>L'Inspiré Visionnaire (11/2) :</strong> Maître Nombre. Votre mission est double : vous incarnez l'intuition fulgurante et la révélation du 11, tout en devant apprendre la diplomatie et la coopération du 2. C'est un chemin de haute tension spirituelle, qui vous demande de faire le pont entre le monde visible et invisible.
                            <div class="interpretation-details">
                                <p><strong>Vos forces sur ce chemin :</strong></p>
                                <ul><li>Intuition exceptionnelle et capacité à canaliser des idées novatrices.</li><li>Charisme magnétique et potentiel pour inspirer les foules.</li><li>Grande sensibilité et empathie (héritées du 2).</li></ul>
                                <p><strong>Les défis à maîtriser :</strong></p>
                                <ul><li>Une forte tension nerveuse et de l'anxiété due à l'hyper-sensibilité.</li><li>Le décalage entre vos idéaux élevés et la réalité, pouvant mener à la frustration.</li><li>La difficulté à vivre la mission du 11, menant à un repli sur les aspects plus passifs du 2.</li></ul>
                                <p><strong>Votre clé d'évolution :</strong> Ancrez votre vision. Votre défi est de ne pas rester dans le monde des idées. Utilisez la patience et la diplomatie du 2 pour concrétiser vos inspirations et les rendre accessibles aux autres. Vous êtes un phare, apprenez à briller sans vous brûler.</p>
                            </div>`,
                        22: `<strong>Le Grand Bâtisseur (22/4) :</strong> Maître Nombre. Votre mission est monumentale : transformer les rêves les plus ambitieux en réalisations concrètes au service de l'humanité. Vous combinez la vision illimitée du 22 avec le pragmatisme et la méthode du 4.
                            <div class="interpretation-details">
                                <p><strong>Vos forces sur ce chemin :</strong></p>
                                <ul><li>Vision à grande échelle et capacité à gérer des projets complexes.</li><li>Endurance, pragmatisme et discipline exceptionnels (hérités du 4).</li><li>Potentiel pour laisser un héritage durable et significatif.</li></ul>
                                <p><strong>Les défis à maîtriser :</strong></p>
                                <ul><li>Une pression immense et la peur de ne pas être à la hauteur de son potentiel.</li><li>La tendance à l'obstination et à la rigidité du 4 si la vision du 22 est perdue.</li><li>La tentation d'utiliser ce pouvoir à des fins purement personnelles.</li></ul>
                                <p><strong>Votre clé d'évolution :</strong> Construisez pas à pas. Votre vision est vaste, mais elle ne se réalisera qu'à travers le travail méthodique et persévérant du 4. Le succès vient en décomposant vos rêves immenses en étapes réalisables. La grandeur se trouve dans chaque brique que vous posez avec conscience.</p>
                            </div>`,
                        33: `<strong>Le Guide Spirituel (33/6) :</strong> Maître Nombre. Votre mission est celle du service aimant et de la guérison à une échelle universelle. Vous portez l'amour inconditionnel et le sens des responsabilités du 6 à son octave supérieure, devenant un guide ou un enseignant pour les autres.
                            <div class="interpretation-details">
                                <p><strong>Vos forces sur ce chemin :</strong></p>
                                <ul><li>Compassion et altruisme immenses.</li><li>Capacité à enseigner, guérir et conseiller avec une grande sagesse.</li><li>Talents artistiques et créatifs au service de l'élévation des consciences.</li></ul>
                                <p><strong>Les défis à maîtriser :</strong></p>
                                <ul><li>Le fardeau des responsabilités, pouvant mener à l'épuisement ou au sacrifice.</li><li>La difficulté à mettre des limites saines et à ne pas absorber les souffrances du monde.</li><li>Le perfectionnisme et l'autocritique (hérités du 6).</li></ul>
                                <p><strong>Votre clé d'évolution :</strong> La joie dans le service. Votre mission n'est pas de porter le monde sur vos épaules, mais d'être un exemple vivant de l'amour et de la joie. Apprenez à servir sans souffrir, en trouvant l'équilibre parfait entre donner aux autres et prendre soin de votre propre lumière intérieure.</p>
                            </div>`
                    },
                    // Les autres sections (expression, ame, etc.) peuvent être enrichies de la même manière.
                    // Pour garder la réponse concise, je vais me concentrer sur le Chemin de Vie qui est le plus important,
                    // mais le principe est le même pour toutes les interprétations. Voici des exemples plus courts pour les autres.
                    expression: {
                        1: "<strong>Le Potentiel du Leader :</strong> Vous êtes ici pour diriger, innover et agir. Vos outils sont le courage, l'indépendance et une volonté de fer. Utilisez-les pour initier des projets et tracer votre propre chemin. Attention à ne pas devenir autoritaire.",
                        5: "<strong>Le Potentiel de l'Agent du Changement :</strong> Vos outils sont la polyvalence, la communication et une incroyable capacité d'adaptation. Vous êtes fait pour le mouvement, les voyages et la nouveauté. Votre défi est de ne pas vous disperser et d'utiliser cette liberté de manière constructive.",
                        9: "<strong>Le Potentiel de l'Humaniste :</strong> Vos dons sont la compassion, l'altruisme et une vision globale. Vous avez le potentiel d'inspirer et d'aider les autres à grande échelle. Apprenez à donner sans vous épuiser et à finaliser vos projets pour que votre impact soit réel."
                    },
                    ame: {
                        1: "<strong>Désir Profond d'Indépendance :</strong> Au plus profond de vous, votre âme aspire à être numéro un, à être libre de toute contrainte et à suivre sa propre voie. Vous avez un besoin viscéral d'autonomie et de reconnaissance pour vos propres mérites. Ce désir est le moteur de votre ambition.",
                        8: "<strong>Désir Profond de Maîtrise et d'Impact :</strong> Votre âme est animée par une quête de pouvoir et de réalisation matérielle. Vous ne cherchez pas l'argent pour l'argent, mais pour la sécurité, la liberté et l'impact qu'il permet. Vous aspirez à construire quelque chose de grand et de durable.",
                        11: "<strong>Désir Profond de Révélation :</strong> Votre âme a soif de connexion spirituelle et d'intuition. Vous êtes motivé par un besoin de comprendre les vérités cachées et de vivre une vie inspirée, en accord avec des idéaux élevés. L'ordinaire vous ennuie ; vous cherchez l'extraordinaire."
                    },
                    personnalite: {
                        6: "<strong>Image du Conseiller Fiable :</strong> Les autres vous perçoivent comme une personne chaleureuse, responsable et digne de confiance. On vient naturellement vers vous pour chercher conseil ou réconfort. Vous dégagez une aura de stabilité et de bienveillance, celle d'un pilier sur lequel on peut s'appuyer.",
                        33: "<strong>Image du Guide Charismatique (33/6) :</strong> Vous projetez une image d'une sagesse et d'une compassion exceptionnelles. Les autres ressentent votre aura de guide et sont attirés par votre capacité à apaiser et à inspirer. Attention à ne pas être écrasé par les attentes que cette image puissante peut générer."
                    },
                    nombreActif: {
                        8: "<strong>Action Puissante et Stratégique :</strong> Quand vous décidez d'agir, vous le faites avec force et ambition. Votre mode d'action est direct, efficace et orienté vers des résultats concrets. Vous n'avez pas peur de prendre les commandes pour atteindre vos objectifs.",
                    }
                },
                
                dailyVibration: { 1:"<strong>Initiative & Action :</strong> Journée idéale pour démarrer de nouveaux projets et affirmer votre indépendance. Prenez les devants !", 2:"<strong>Patience & Diplomatie :</strong> Ralentissez. C'est un jour pour écouter, collaborer et faire preuve de tact. Favorisez les partenariats.", 3:"<strong>Créativité & Communication :</strong> Exprimez-vous ! Une excellente journée pour socialiser, rire, créer et partager vos idées avec optimisme.", 4:"<strong>Travail & Organisation :</strong> Concentrez-vous sur les détails et le travail méthodique. Journée parfaite pour ranger, planifier et construire des bases solides.", 5:"<strong>Changement & Aventure :</strong> Attendez-vous à l'inattendu. Soyez flexible, ouvert aux nouvelles expériences et prêt à bouger. Évitez la routine.", 6:"<strong>Harmonie & Responsabilités :</strong> Le foyer et les relations sont au centre. Un jour pour prendre soin de vos proches, embellir votre environnement et assumer vos responsabilités.", 7:"<strong>Introspection & Réflexion :</strong> Prenez du temps pour vous. C'est un jour pour analyser, méditer, et chercher des réponses à l'intérieur. Ne forcez rien.", 8:"<strong>Ambition & Pouvoir :</strong> Concentrez-vous sur vos finances et votre carrière. Journée propice aux décisions importantes, aux négociations et à l'affirmation de votre autorité.", 9:"<strong>Bilan & Altruisme :</strong> C'est un jour pour finaliser, pardonner et lâcher-prise. Aidez les autres et terminez ce qui est en cours avant de commencer du neuf.", 11: "<strong>Intuition & Révélation (11/2) :</strong> Une journée de grande sensibilité. Fiez-vous à votre intuition (11), elle est particulièrement forte. Les tensions sont possibles, cherchez l'harmonie du 2.", 22: "<strong>Construction & Vision (22/4) :</strong> Potentiel de réaliser quelque chose de grand. C'est un jour 4 à une échelle supérieure. Rêvez grand (22), mais ancrez vos actions dans le concret (4).", 33: "<strong>Compassion & Guérison (33/6) :</strong> Journée de service et d'amour universel (33). Une énergie de jour 6 amplifiée. Soyez une source d'inspiration et de réconfort pour les autres." },
                compatibility: {
                    relations: { '1': { harmony: [1, 3, 5], challenge: [6, 8], neutral: [2, 4, 7, 9] }, '2': { harmony: [2, 4, 6, 8], challenge: [5, 7], neutral: [1, 3, 9] }, '3': { harmony: [1, 3, 5, 6, 9], challenge: [], neutral: [2, 4, 7, 8] }, '4': { harmony: [2, 4, 6, 8], challenge: [5, 7], neutral: [1, 3, 9] }, '5': { harmony: [1, 3, 5], challenge: [2, 4], neutral: [6, 7, 8, 9] }, '6': { harmony: [2, 3, 4, 6, 9], challenge: [1, 8], neutral: [5, 7] }, '7': { harmony: [7, 9], challenge: [2, 4, 8], neutral: [1, 3, 5, 6] }, '8': { harmony: [2, 4, 6, 8], challenge: [1, 7], neutral: [3, 5, 9] }, '9': { harmony: [3, 6, 9], challenge: [], neutral: [1, 2, 4, 5, 7, 8] }, },
                    summary: { harmony: "Dynamique très favorable, marquée par une compréhension et un soutien mutuels. Les énergies s'alignent naturellement.", challenge: "Relation de croissance. Les différences peuvent créer des frictions, mais offrent de puissantes leçons si elles sont comprises.", neutral: "Compatibilité équilibrée. La relation dépendra de la volonté des deux partenaires de s'adapter et de communiquer." }
                }
            };

            // ========================== OBJET `calculator` ==========================
            // Cet objet contient toute la logique de calcul. Il est indépendant de l'interface utilisateur,
            // ce qui le rend pur et facile à tester. C'est le "moteur" de l'application.
            const calculator = {
                /**
                 * Réduit un nombre par addition théosophique jusqu'à obtenir un seul chiffre (1-9) ou un Maître Nombre (11, 22, 33).
                 * @param {number|string} n - Le nombre à réduire.
                 * @param {boolean} [keepMasters=true] - Si vrai, la réduction s'arrête si le nombre est 11, 22 ou 33.
                 * @returns {number} Le nombre réduit.
                 */
                reduceNumber(n, keepMasters = true) {
                    let num = parseInt(n, 10);
                    if (isNaN(num)) return 0;
                    // La boucle continue tant que le nombre est supérieur à 9 ET (soit on ne garde pas les maîtres, soit le nombre n'en est pas un).
                    while (num > 9 && (!keepMasters || !data.masterNumbers.includes(num))) {
                        num = String(num).split('').reduce((acc, digit) => acc + parseInt(digit, 10), 0);
                    }
                    return num;
                },

                /**
                 * Calcule un nombre numérologique complexe, identifiant sa valeur finale, sa dette karmique éventuelle et sa valeur de base s'il s'agit d'un maître nombre.
                 * @param {number} sum - La somme initiale avant toute réduction.
                 * @returns {object} Un objet contenant la valeur finale, la dette karmique, la somme initiale et la valeur de base.
                 */
                calculateComplexNumber(sum) {
                    const karmicDebt = Object.keys(data.karmicDebtsMap).map(Number).includes(sum) ? sum : null;
                    const finalValue = this.reduceNumber(sum);
                    let baseValue = null;
                    if(data.masterNumbers.includes(finalValue)) {
                        baseValue = this.reduceNumber(finalValue, false); // On réduit le maître nombre pour obtenir sa base (ex: 22 -> 4).
                    }
                    return { value: finalValue, karmicDebt, initialSum: sum, baseValue };
                },

                /**
                 * Calcule la valeur numérologique d'un nom ou prénom en fonction du type de lettres à additionner (toutes, voyelles, consonnes).
                 * @param {string} name - La chaîne de caractères à analyser.
                 * @param {'all'|'vowels'|'consonants'} type - Le type de lettres à prendre en compte.
                 * @returns {object} Un objet complexe avec la valeur, la dette, les détails du calcul, etc.
                 */
                calculateNameNumber(name, type) {
                    if (!name) return { value: 0, initialSum: 0, karmicDebt: null, baseValue: null, details: "Aucun nom fourni" };
                    // Normalise le nom : enlève les accents, met en majuscules, et supprime les caractères non alphabétiques.
                    const normalizedName = name.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().replace(/[^A-Z\s]/g, '');
                    let sum = 0;
                    let details = []; // Pour stocker les étapes du calcul à des fins d'affichage.
                    for (const char of normalizedName) {
                        if (char === ' ') continue;
                        const isVowel = data.vowels.includes(char);
                        if ((type === 'all') || (type === 'vowels' && isVowel) || (type === 'consonants' && !isVowel)) {
                            const value = data.letterValues[char] || 0;
                            sum += value;
                            details.push(`${char}(${value})`);
                        }
                    }
                    if (details.length === 0) return { value: 0, initialSum: 0, karmicDebt: null, baseValue: null, details: "Aucune lettre valide trouvée." };
                    const result = this.calculateComplexNumber(sum);
                    result.details = `${details.join(' + ')} = ${result.initialSum}${result.karmicDebt ? ` (Dette ${result.karmicDebt})` : ''} ➔ ${result.value}`;
                    return result;
                },

                /**
                 * Calcule le Chemin de Vie à partir d'une date de naissance (format YYYY-MM-DD).
                 * Méthode : Jour réduit + Mois réduit + Année réduite.
                 * @param {string} date - La date de naissance au format 'YYYY-MM-DD'.
                 * @returns {object} Le résultat du Chemin de Vie.
                 */
                calculateLifePath(date) {
                    const [year, month, day] = date.split('-');
                    // Chaque partie de la date est réduite séparément avant d'être additionnée. C'est une méthode de calcul courante.
                    const sum = this.reduceNumber(day, false) + this.reduceNumber(month, false) + this.reduceNumber(year, false);
                    const result = this.calculateComplexNumber(sum);
                    result.details = `Jour(${this.reduceNumber(day, false)}) + Mois(${this.reduceNumber(month, false)}) + Année(${this.reduceNumber(year, false)}) = ${result.initialSum} ➔ ${result.value}`;
                    return result;
                },

                /**
                 * Calcule la Vibration du Jour en combinant la date de naissance de l'utilisateur avec la date actuelle.
                 * @param {string} birthDate - Date de naissance de l'utilisateur ('YYYY-MM-DD').
                 * @returns {object} Le résultat de la vibration du jour.
                 */
                calculateDailyVibration(birthDate) {
                    if (!birthDate) return { value: 0, baseValue: null };
                    const today = new Date();
                    const [year, month, day] = birthDate.split('-').map(Number);
                    const sum = this.reduceNumber(day, false) + this.reduceNumber(month, false) + this.reduceNumber(today.getDate(), false) + this.reduceNumber(today.getMonth() + 1, false) + this.reduceNumber(today.getFullYear(), false);
                    return this.calculateComplexNumber(sum);
                },

                /**
                 * Calcule la présence de chaque énergie (1-9) dans le nom complet de l'utilisateur.
                 * @param {string} fullName - Le nom complet.
                 * @returns {object} Un objet avec le compte pour chaque nombre (ex: {1: 3, 2: 1, ...}).
                 */
                calculateEnergyPresence(fullName) {
                    const presence = { 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, 7:0, 8:0, 9:0 };
                    const normalizedName = fullName.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toUpperCase().replace(/[^A-Z]/g, '');
                    for (const char of normalizedName) {
                        if (data.letterValues[char]) {
                            presence[data.letterValues[char]]++;
                        }
                    }
                    return presence;
                },

                /**
                 * Calcule les 4 grands cycles de vie (pinacles et défis).
                 * @param {string} birthDate - La date de naissance 'YYYY-MM-DD'.
                 * @param {number} lifePathValue - La valeur réduite du chemin de vie.
                 * @returns {Array<object>} Un tableau d'objets, chacun représentant un cycle de vie.
                 */
                calculateLifeCycles(birthDate, lifePathValue) {
                    const [year, month, day] = birthDate.split('-').map(Number);
                    const dayR = this.reduceNumber(day, false), monthR = this.reduceNumber(month, false), yearR = this.reduceNumber(year, false);
                    // L'âge de transition du premier au deuxième cycle est calculé à partir du chemin de vie.
                    const age1 = 36 - this.reduceNumber(lifePathValue, false);
                    return [
                        { age: `0 à ${age1} ans`, pinnacle: this.reduceNumber(monthR + dayR, false), challenge: this.reduceNumber(Math.abs(monthR - dayR), false) },
                        { age: `${age1 + 1} à ${age1 + 9} ans`, pinnacle: this.reduceNumber(dayR + yearR, false), challenge: this.reduceNumber(Math.abs(dayR - yearR), false) },
                        { age: `${age1 + 10} à ${age1 + 18} ans`, pinnacle: this.reduceNumber(this.reduceNumber(monthR + dayR, false) + this.reduceNumber(dayR + yearR, false), false), challenge: this.reduceNumber(Math.abs(this.reduceNumber(Math.abs(monthR - dayR), false) - this.reduceNumber(Math.abs(dayR - yearR), false)), false) },
                        { age: `Après ${age1 + 18} ans`, pinnacle: this.reduceNumber(monthR + yearR, false), challenge: this.reduceNumber(Math.abs(monthR - yearR), false) }
                    ];
                },
                
                /**
                 * Fonction principale du calculateur. Orchestre tous les calculs pour générer un thème complet.
                 * @param {string} fullName - Le nom complet de l'utilisateur.
                 * @param {string} birthDate - La date de naissance 'YYYY-MM-DD'.
                 * @returns {object} Un objet contenant tous les résultats du thème numérologique.
                 */
                getTheme(fullName, birthDate) {
                    const cleanedFullName = fullName.trim().replace(/\s+/g, ' ');
                    const firstName = cleanedFullName.split(' ')[0];
                    const lifePath = this.calculateLifePath(birthDate);
                    return {
                        fullName: cleanedFullName, firstName, birthDate, lifePath,
                        expression: this.calculateNameNumber(cleanedFullName, 'all'),
                        soul: this.calculateNameNumber(cleanedFullName, 'vowels'),
                        personality: this.calculateNameNumber(cleanedFullName, 'consonants'),
                        active: this.calculateNameNumber(firstName, 'all'),
                        dailyVibration: this.calculateDailyVibration(birthDate),
                        energyPresence: this.calculateEnergyPresence(cleanedFullName),
                        lifeCycles: this.calculateLifeCycles(birthDate, lifePath.value),
                    };
                }
            };

            // ========================== OBJET `ui` ==========================
            // Cet objet gère toutes les interactions avec le DOM (Document Object Model).
            // Il est responsable de l'écoute des événements (clics, soumissions de formulaires)
            // et de l'affichage des résultats calculés. C'est le "contrôleur" et la "vue" de l'application.
            const ui = {
                // Centralise tous les éléments du DOM pour un accès facile et performant.
                elements: {
                    form: document.getElementById('numerology-form'), nameInput: document.getElementById('full-name'), dateInput: document.getElementById('birth-date'),
                    resultsWrapper: document.getElementById('results-wrapper'), dailyVibrationContainer: document.getElementById('daily-vibration-container'),
                    summaryContainer: document.getElementById('summary-container'), energyContainer: document.getElementById('energy-presence-container'),
                    cyclesContainer: document.getElementById('life-cycles-container'), resultsContainer: document.getElementById('results-container'),
                    profileCardContainer: document.getElementById('profile-card-container'), profileCardCanvas: document.getElementById('profile-card-canvas'),
                    printBtn: document.getElementById('print-btn'), aiExportBtn: document.getElementById('ai-export-btn'), profileCardBtn: document.getElementById('profile-card-btn'),
                    themeToggle: document.getElementById('theme-toggle'), welcomeBack: document.getElementById('welcome-back'),
                    navTheme: document.getElementById('nav-theme'), navCompatibility: document.getElementById('nav-compatibility'),
                    themeContent: document.getElementById('theme-content'), compatibilityContent: document.getElementById('compatibility-content'),
                    compatForm: document.getElementById('compatibility-form'), p1Name: document.getElementById('p1-full-name'), p1Date: document.getElementById('p1-birth-date'),
                    p2Name: document.getElementById('p2-full-name'), p2Date: document.getElementById('p2-birth-date'), compatResultsContainer: document.getElementById('compatibility-results'),
                    glossaryModal: document.getElementById('glossary-modal'), modalCloseBtn: document.getElementById('modal-close-btn'), modalBody: document.getElementById('modal-body'),
                    methodologyModal: document.getElementById('methodology-modal'), methodologyCloseBtn: document.getElementById('methodology-close-btn'), methodologyModalBody: document.getElementById('methodology-modal-body'), methodologyLink: document.getElementById('methodology-link'),
                },

                /**
                 * Initialise l'interface utilisateur en attachant tous les écouteurs d'événements nécessaires.
                 * C'est le point d'entrée de l'objet `ui`.
                 */
                init() {
                    // Gestion du mode sombre : applique le thème et enregistre le choix de l'utilisateur.
                    this.elements.themeToggle.addEventListener('change', () => { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light'); });
                    if (localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); this.elements.themeToggle.checked = true; }
                    
                    // Gestion de la navigation par onglets.
                    this.elements.navTheme.addEventListener('click', () => this.toggleView('theme'));
                    this.elements.navCompatibility.addEventListener('click', () => this.toggleView('compatibility'));
                    
                    // Gestion de la soumission des formulaires.
                    this.elements.form.addEventListener('submit', e => { e.preventDefault(); this.handleThemeSubmit(); });
                    this.elements.compatForm.addEventListener('submit', e => { e.preventDefault(); this.handleCompatibilitySubmit(e); });
                    
                    // Formatage automatique des dates lors de la saisie.
                    [this.elements.dateInput, this.elements.p1Date, this.elements.p2Date].forEach(input => { input.addEventListener('input', this.formatDateInput); });
                    
                    // Récupération des données de l'utilisateur depuis le localStorage pour pré-remplir le formulaire.
                    const savedUser = JSON.parse(localStorage.getItem('numerologyUser'));
                    if (savedUser && savedUser.name && savedUser.date) {
                        this.elements.nameInput.value = savedUser.name;
                        this.elements.dateInput.value = this.formatDateForDisplay(savedUser.date);
                        this.elements.p1Name.value = savedUser.name;
                        this.elements.p1Date.value = this.formatDateForDisplay(savedUser.date);
                        this.elements.welcomeBack.innerHTML = `Heureux de vous revoir, ${savedUser.name.split(' ')[0]} !`;
                        this.elements.welcomeBack.classList.remove('hidden');
                        this.displayThemeResults(savedUser.name, savedUser.date, true); // `true` pour indiquer un rechargement.
                    }

                    // Gestion de la fermeture des modales.
                    this.elements.modalCloseBtn.onclick = () => this.elements.glossaryModal.style.display = "none";
                    this.elements.methodologyCloseBtn.onclick = () => this.elements.methodologyModal.style.display = "none";
                    this.elements.methodologyLink.onclick = () => this.openMethodologyModal();
                    
                    // Permet de fermer la modale en cliquant en dehors de celle-ci.
                    window.onclick = (event) => {
                        if (event.target == this.elements.glossaryModal) this.elements.glossaryModal.style.display = "none";
                        if (event.target == this.elements.methodologyModal) this.elements.methodologyModal.style.display = "none";
                    };
                },
                
                /**
                 * Formate un objet résultat pour l'affichage, gérant les maîtres nombres (ex: 22/4).
                 * @param {object} result - L'objet résultat du calculateur.
                 * @returns {string} La chaîne de caractères formatée.
                 */
                formatNumberForDisplay(result) {
                    if (result && result.baseValue) { return `${result.value}/${result.baseValue}`; }
                    return result ? result.value : '';
                },

                /**
                 * Génère le contenu HTML pour les cercles de nombres, avec une gestion spéciale pour les maîtres nombres.
                 * @param {object} result - L'objet résultat du calculateur.
                 * @returns {string} Le HTML pour le contenu du cercle.
                 */
                generateCircleHTML(result) {
                    if (result && result.baseValue) {
                        return `<span class="master-part">${result.value}</span><hr class="separator"><span class="base-part">${result.baseValue}</span>`;
                    }
                    return result ? result.value : '';
                },

                /**
                 * Analyse et valide une chaîne de date au format 'JJ/MM/AAAA' et la convertit en 'YYYY-MM-DD'.
                 * @param {string} dateString - La date à analyser.
                 * @returns {string|null} La date au format 'YYYY-MM-DD' ou null si invalide.
                 */
                parseAndValidateDate(dateString) {
                    const regex = /^(\d{2})\/(\d{2})\/(\d{4})$/; if (!regex.test(dateString)) return null;
                    const [, day, month, year] = dateString.match(regex);
                    const date = new Date(`${year}-${month}-${day}T00:00:00`);
                    if (date.getFullYear() != year || (date.getMonth() + 1) != month || date.getDate() != day) return null; // Vérifie la validité de la date (ex: 31/02/2023).
                    return `${year}-${month.padStart(2,'0')}-${day.padStart(2,'0')}`;
                },

                formatDateForDisplay(dateString) { if (!dateString) return ''; const [year, month, day] = dateString.split('-'); return `${day}/${month}/${year}`; },
                formatDateInput(e) { let input = e.target; let value = input.value.replace(/\D/g, ''); if (value.length > 2) value = value.slice(0, 2) + '/' + value.slice(2); if (value.length > 5) value = value.slice(0, 5) + '/' + value.slice(5, 9); input.value = value; },
                
                /**
                 * Gère l'affichage des onglets (Thème ou Compatibilité).
                 * @param {'theme'|'compatibility'} view - La vue à afficher.
                 */
                toggleView(view) {
                    const isTheme = view === 'theme';
                    this.elements.themeContent.classList.toggle('active', isTheme);
                    this.elements.compatibilityContent.classList.toggle('active', !isTheme);
                    this.elements.navTheme.classList.toggle('active', isTheme);
                    this.elements.navCompatibility.classList.toggle('active', !isTheme);
                },

                /**
                 * Gère la soumission du formulaire de thème principal.
                 */
                handleThemeSubmit() {
                    const fullName = this.elements.nameInput.value; const birthDate = this.parseAndValidateDate(this.elements.dateInput.value);
                    if (!fullName || !birthDate) { alert("Veuillez remplir tous les champs, avec une date valide au format JJ/MM/AAAA."); return; }
                    localStorage.setItem('numerologyUser', JSON.stringify({ name: fullName, date: birthDate }));
                    this.displayThemeResults(fullName, birthDate, false);
                    this.elements.p1Name.value = fullName; this.elements.p1Date.value = this.formatDateForDisplay(birthDate);
                },
                
                /**
                 * Gère la soumission du formulaire de compatibilité.
                 */
                handleCompatibilitySubmit(e){
                    const p1Name = this.elements.p1Name.value; const p1Date = this.parseAndValidateDate(this.elements.p1Date.value);
                    const p2Name = this.elements.p2Name.value; const p2Date = this.parseAndValidateDate(this.elements.p2Date.value);
                    if(!p1Name || !p1Date || !p2Name || !p2Date) { alert("Veuillez remplir les informations des deux personnes, avec des dates valides au format JJ/MM/AAAA."); return; }
                    const p1Theme = calculator.getTheme(p1Name, p1Date); const p2Theme = calculator.getTheme(p2Name, p2Date);
                    this.displayCompatibilityResults(p1Theme, p2Theme); e.target.querySelector('button').scrollIntoView({ behavior: 'smooth', block: 'end' });
                },

                /**
                 * Affiche tous les résultats du thème numérologique.
                 * @param {string} fullName - Nom complet de l'utilisateur.
                 * @param {string} birthDate - Date de naissance ('YYYY-MM-DD').
                 * @param {boolean} isReload - Vrai si les données proviennent du cache (localStorage).
                 */
                displayThemeResults(fullName, birthDate, isReload) {
                    const theme = calculator.getTheme(fullName, birthDate);
                    const mainResults = new Map([
                        ['Chemin de Vie', { key: 'cheminDeVie', result: theme.lifePath, description: "Votre mission de vie, les grandes leçons à apprendre et le potentiel à réaliser." }],
                        ['Nombre d\'Expression', { key: 'expression', result: theme.expression, description: "Vos talents et potentiels innés. Ce sont vos outils pour naviguer la vie." }],
                        ['Nombre de l\'Âme', { key: 'ame', result: theme.soul, description: "Vos désirs profonds, ce qui vous motive et vous anime de l'intérieur." }],
                        ['Nombre de Personnalité', { key: 'personnalite', result: theme.personality, description: "L'image que vous projetez, la première impression que les autres ont de vous." }],
                        ['Nombre Actif', { key: 'nombreActif', result: theme.active, description: "Votre énergie d'action, la façon dont vous initiez les choses." }]
                    ]);
                    
                    // Affiche les différentes sections des résultats.
                    this.displayDailyVibration(theme.dailyVibration);
                    this.displaySummary(theme.lifePath, theme.expression);
                    this.displayEnergyChart(theme.energyPresence);
                    this.displayLifeCycles(theme.lifeCycles);

                    this.elements.resultsContainer.innerHTML = ''; // Vide les anciens résultats.
                    mainResults.forEach((resultData, title) => { this.elements.resultsContainer.appendChild(this.createResultCard(title, resultData)); });
                    
                    this.elements.resultsWrapper.classList.remove('hidden'); // Affiche le conteneur des résultats.
                    this.animateCards('#theme-content .card'); // Lance l'animation des cartes.
                    if (!isReload) { setTimeout(() => this.elements.resultsWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' }), 200); } // Défile vers les résultats.
                    this.setupActionButtons(theme, mainResults); // Configure les boutons d'action (IA, PDF...).
                },
                
                /**
                 * Crée une carte de résultat HTML à partir des données d'un nombre.
                 * @param {string} title - Le titre de la carte (ex: "Chemin de Vie").
                 * @param {object} resultData - L'objet contenant les informations du résultat.
                 * @returns {HTMLElement} L'élément div de la carte.
                 */
                createResultCard(title, resultData) {
                    const interpretationText = data.interpretations[resultData.key]?.[resultData.result.value] || "Interprétation non disponible.";
                    const card = document.createElement('div');
                    card.className = 'card result-card';
                    const circleHTML = this.generateCircleHTML(resultData.result);
                    let karmicHTML = '';
                    if(resultData.result.karmicDebt) {
                        karmicHTML = `<div class="karmic-warning">⚠️ <strong>Défi Karmique ${resultData.result.karmicDebt} :</strong> Ce nombre indique un défi spécifique, un 'frein' à transformer en force, lié à ${data.karmicDebtsMap[resultData.result.karmicDebt]}.</div>`;
                    }
                    let methodologyNoteHTML = '';
                    if(title === 'Nombre de l\'Âme') {
                        methodologyNoteHTML = `<p class="methodology-note">ℹ️ Calculé avec les voyelles du nom complet (A, E, I, O, U, Y). Voir "Notre Méthodologie" en bas de page pour plus de détails.</p>`;
                    }
                    card.innerHTML = `<h2><span class="number-circle" data-number="${resultData.result.value}">${circleHTML}</span>${title}</h2><p class="description">${resultData.description}</p><div>${interpretationText}</div>${karmicHTML}<details><summary>Voir le calcul</summary><div class="calculation-details" style="font-size:0.9em; opacity:0.8; padding-top:10px;">${resultData.result.details}</div></details>${methodologyNoteHTML}`;
                    // Ajoute un événement pour ouvrir le glossaire au clic sur le cercle.
                    card.querySelector('.number-circle').addEventListener('click', (e) => this.openGlossaryModal(e.currentTarget.dataset.number));
                    return card;
                },

                /** Affiche la carte de la vibration du jour. */
                displayDailyVibration(vibration) {
                    const circleHTML = this.generateCircleHTML(vibration);
                    this.elements.dailyVibrationContainer.innerHTML = `<div class="card daily-vibration-card"><h2 class="fade-in"><span class="number-circle" data-number="${vibration.value}">${circleHTML}</span>Votre Vibration du Jour</h2><p class="description fade-in">${data.dailyVibration[vibration.value] || "Journée d'énergie intense et de potentiel élevé."}</p></div>`;
                    this.elements.dailyVibrationContainer.querySelector('.number-circle').addEventListener('click', (e) => this.openGlossaryModal(e.currentTarget.dataset.number));
                },
                
                /** Affiche la carte de synthèse stratégique (Chemin de Vie vs Expression). */
                displaySummary(lifePath, expression) {
                    const lpDisplay = this.formatNumberForDisplay(lifePath);
                    const expDisplay = this.formatNumberForDisplay(expression);
                    const lpText = data.interpretations.cheminDeVie[lifePath.value]?.match(/<strong>(.*?) :<\/strong>/)[1] || "inconnu";
                    const expText = data.interpretations.expression[expression.value]?.match(/<strong>(.*?) :<\/strong>/)[1] || "inconnu";
                    let summaryText = `La clé de votre épanouissement réside dans la relation entre votre <strong>mission de vie (Chemin de Vie ${lpDisplay})</strong> et vos <strong>outils innés (Nombre d'Expression ${expDisplay})</strong>.<br><br>Votre mission est de devenir <strong>${lpText}</strong>. Pour y parvenir, vous disposez naturellement des talents d'un(e) <strong>${expText}</strong>. L'art consiste à utiliser consciemment vos outils pour avancer sur votre chemin.`;
                    
                    if (lifePath.value === expression.value || (lifePath.baseValue && lifePath.baseValue === expression.value)) {
                        summaryText += "<br><br>✨ <strong>Synergie Puissante :</strong> Votre mission et vos talents sont en alignement parfait. Cela vous donne une grande force et une clarté d'objectif, mais attention à ne pas rester dans votre zone de confort.";
                    } else {
                        summaryText += "<br><br>💡 <strong>Dynamique de Croissance :</strong> Vos outils et votre mission sont différents. Cette tension est votre plus grande force : elle vous pousse à développer de nouvelles facettes de votre personnalité pour atteindre votre plein potentiel.";
                    }
                    this.elements.summaryContainer.innerHTML = `<div class="card summary-card" style="border-left-color: var(--summary-border);"><h2>✨ Votre Duo Stratégique</h2><p>${summaryText}</p></div>`;
                },

                /** Génère et affiche le graphique en barres des énergies présentes dans le nom. */
                displayEnergyChart(presenceData) {
                    const analysis = this.generateEnergyAnalysis(presenceData);
                    const container = this.elements.energyContainer;
                    // Dimensions du SVG pour la vue de la boîte.
                    const chartWidth = 400; const chartHeight = 170;
                    const barWidth = 30; const barMargin = 15;
                    let maxPresence = Math.max(...Object.values(presenceData));
                    if (maxPresence === 0) maxPresence = 1; // Évite la division par zéro.
                    let svgContent = `<svg width="100%" viewBox="0 0 ${chartWidth} ${chartHeight}" preserveAspectRatio="xMidYMid meet">`;
                    Object.entries(presenceData).forEach(([num, count], index) => {
                        const barHeight = (count / maxPresence) * (chartHeight - 30);
                        const x = index * (barWidth + barMargin);
                        const y = chartHeight - barHeight - 20;
                        svgContent += `<g transform="translate(${x}, 0)"><rect x="0" y="${y}" width="${barWidth}" height="${barHeight}" fill="var(--secondary-color)" rx="3"><title>${data.energyKeywords[num]} (présent ${count} fois)</title></rect><text x="${barWidth / 2}" y="${chartHeight - 5}" font-family="Poppins" font-size="12" fill="var(--text-color)" text-anchor="middle">${num}</text></g>`;
                    });
                    svgContent += `</svg>`;
                    container.innerHTML = `<div class="card chart-card"><h2 style="font-size: 1.5em;">📊 Vos Énergies Innées (dans le nom)</h2><p class="description">Ce graphique révèle vos forces naturelles (barres hautes) et vos axes de développement (barres basses ou absentes).</p><div class="energy-chart-svg-container">${svgContent}</div>${analysis}</div>`;
                },

                /** Génère une analyse textuelle basée sur les énergies dominantes et manquantes. */
                generateEnergyAnalysis(presenceData) {
                    const maxCount = Math.max(...Object.values(presenceData));
                    if (maxCount === 0) return "";
                    const maxEnergies = Object.keys(presenceData).filter(k => presenceData[k] === maxCount).map(Number);
                    const lackingEnergies = Object.keys(presenceData).filter(k => presenceData[k] === 0).map(Number);
                    let analysisHTML = '<div class="energy-analysis"><p><strong>Analyse de votre potentiel :</strong> ';
                    analysisHTML += `Vos énergies dominantes sont le <strong>${maxEnergies.map(n => `${n} (${data.energyKeywords[n]})`).join(' et le ')}</strong>. Ce sont vos talents les plus évidents, des forces sur lesquelles vous pouvez vous appuyer. `;
                    if (lackingEnergies.length > 0) {
                        analysisHTML += `À l'inverse, les énergies <strong>${lackingEnergies.map(n => `${n} (${data.energyKeywords[n]})`).join(', ')}</strong> sont vos <strong>axes de croissance</strong>. Intégrer consciemment ces qualités dans votre vie vous aidera à surmonter certains blocages et à trouver un meilleur équilibre.`;
                    }
                    analysisHTML += '</p></div>';
                    return analysisHTML;
                },
                
                /** Affiche les cartes des 4 cycles de vie. */
                displayLifeCycles(cyclesData) {
                    let cyclesHTML = `<div class="card cycles-card"><h2 style="font-size: 1.5em;">🧭 Vos 4 Cycles de Vie</h2><p class="description">Votre vie se divise en grands cycles, chacun avec une ambiance (Pinacle) et une leçon à intégrer (Défi).</p><div class="life-cycles-grid">`;
                    cyclesData.forEach(cycle => { cyclesHTML += `<div class="cycle-card"><h3>${cycle.age}</h3><p><strong>Pinacle ${cycle.pinnacle}:</strong> Opportunités et climat.</p><p><strong>Défi ${cycle.challenge}:</strong> Leçon à maîtriser.</p></div>`; });
                    cyclesHTML += `</div></div>`;
                    this.elements.cyclesContainer.innerHTML = cyclesHTML;
                },
                
                /** Détermine le type de relation (harmonie, défi, neutre) entre deux nombres. */
                getCompatibility(n1, n2) {
                    const r1 = calculator.reduceNumber(n1, false);
                    const r2 = calculator.reduceNumber(n2, false);
                    const rel = data.compatibility.relations[r1];
                    if (!rel) return 'neutral';
                    if (rel.harmony.includes(r2)) return 'harmony';
                    if (rel.challenge.includes(r2)) return 'challenge';
                    return 'neutral';
                },

                /** Affiche les résultats de l'analyse de compatibilité. */
                displayCompatibilityResults(p1, p2) {
                    const container = this.elements.compatResultsContainer;
                    container.innerHTML = '';
                    const aspects = [
                        { title: 'Chemins de Vie (Missions)', res1: p1.lifePath, res2: p2.lifePath, desc: "La mission de vie, la leçon principale." },
                        { title: 'Nombres d\'Expression (Outils)', res1: p1.expression, res2: p2.expression, desc: "Les talents, le mode de fonctionnement." },
                        { title: 'Nombres d\'Âme (Désirs)', res1: p1.soul, res2: p2.soul, desc: "Les désirs profonds, les motivations intimes." }
                    ];
                    aspects.forEach(aspect => {
                        const type = this.getCompatibility(aspect.res1.value, aspect.res2.value);
                        const typeText = { harmony: 'Harmonie', challenge: 'Défi', neutral: 'Neutre' }[type];
                        const card = document.createElement('div');
                        card.className = `card ${type}`;
                        const p1Display = this.formatNumberForDisplay(aspect.res1);
                        const p2Display = this.formatNumberForDisplay(aspect.res2);
                        card.innerHTML = `<h2 style="color: var(--${type}-color);">${typeText} - ${aspect.title}</h2><p><strong>${p1.firstName} (${p1Display}) & ${p2.firstName} (${p2Display})</strong></p><p><em>${aspect.desc}</em></p><p>${data.compatibility.summary[type]}</p>`;
                        container.appendChild(card);
                    });
                    container.classList.remove('hidden');
                    this.animateCards('#compatibility-results .card');
                },
                
                /** Ouvre la modale du glossaire avec les informations sur un nombre spécifique. */
                openGlossaryModal(number) {
                    let html = `<h2>L'Énergie du Nombre ${number}</h2>`;
                    html += `<p><strong>Mot-clé :</strong> ${data.energyKeywords[number]}</p><hr>`;
                    // Parcourt toutes les interprétations pour trouver celles correspondant au nombre.
                    Object.keys(data.interpretations).forEach(key => {
                        if (data.interpretations[key][number]) {
                            const title = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                            html += `<h3>En ${title} :</h3><div>${data.interpretations[key][number]}</div>`;
                        }
                    });
                    this.elements.modalBody.innerHTML = html;
                    this.elements.glossaryModal.style.display = "block";
                },

                /** Ouvre la modale de méthodologie. */
                openMethodologyModal() {
                    const { title, content } = data.methodologyText;
                    this.elements.methodologyModalBody.innerHTML = `<h2>${title}</h2>${content}`;
                    this.elements.methodologyModal.style.display = "block";
                },

                /** Dessine la carte de profil de l'utilisateur sur un élément Canvas. */
                drawProfileCard(theme) {
                    this.elements.profileCardContainer.classList.remove('hidden');
                    const canvas = this.elements.profileCardCanvas; const ctx = canvas.getContext('2d');
                    const isDark = document.body.classList.contains('dark-mode');
                    canvas.width = 500; canvas.height = 500;
                    // Crée un fond en dégradé qui s'adapte au thème.
                    const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                    gradient.addColorStop(0, isDark ? '#2c3e50' : '#4361ee');
                    gradient.addColorStop(1, isDark ? '#1e1e1e' : '#7209b7');
                    ctx.fillStyle = gradient; ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = 'white'; ctx.font = 'bold 32px Lora'; ctx.textAlign = 'center';
                    ctx.fillText(theme.firstName, canvas.width / 2, 80);
                    const numbers = [ { label: "Chemin de Vie", result: theme.lifePath }, { label: "Expression", result: theme.expression }, { label: "Âme", result: theme.soul }, { label: "Personnalité", result: theme.personality } ];
                    ctx.font = '22px Poppins';
                    numbers.forEach((num, index) => {
                        const y = 160 + index * 80;
                        const displayNumber = this.formatNumberForDisplay(num.result);
                        ctx.textAlign = 'left'; ctx.fillText(`${num.label} :`, 100, y);
                        ctx.textAlign = 'right'; ctx.font = 'bold 38px Lora';
                        ctx.fillText(displayNumber, 400, y + 10);
                        ctx.font = '22px Poppins';
                    });
                    this.elements.profileCardContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                },

                /** Applique une animation d'apparition en cascade aux éléments spécifiés par un sélecteur CSS. */
                animateCards(selector) {
                    document.querySelectorAll(selector).forEach((card, index) => {
                        card.classList.remove('fade-in'); void card.offsetWidth; // Force le recalcul du style pour ré-initialiser l'animation.
                        card.style.animationDelay = `${index * 0.07}s`; // Crée un délai pour l'effet de cascade.
                        card.classList.add('fade-in');
                    });
                },

                /** Configure les écouteurs d'événements pour les boutons d'action (Imprimer, Carte, IA). */
                setupActionButtons(theme, resultsMap) {
                    this.elements.printBtn.onclick = () => window.print();
                    this.elements.profileCardBtn.onclick = () => this.drawProfileCard(theme);

                    this.elements.aiExportBtn.innerHTML = '✨ Révéler mon Analyse Stratégique Complète';
                    // Ajoute (ou met à jour) la description sous le bouton de l'IA.
                    let existingDesc = this.elements.aiExportBtn.nextElementSibling;
                    if(existingDesc && existingDesc.classList.contains('ai-prompt-description')) {
                        existingDesc.remove();
                    }
                    const aiDesc = document.createElement('p');
                    aiDesc.className = 'ai-prompt-description';
                    aiDesc.innerHTML = "Copie un prompt optimisé à coller dans une IA (ChatGPT, Gemini, etc.) pour une analyse qui tisse des liens entre tous vos nombres.";
                    this.elements.aiExportBtn.insertAdjacentElement('afterend', aiDesc);
                    
                    // Gère la copie du prompt pour l'IA dans le presse-papiers.
                    this.elements.aiExportBtn.onclick = () => {
                        let resultsForAI = '';
                        resultsMap.forEach((data, title) => {
                            const displayNumber = this.formatNumberForDisplay(data.result);
                            resultsForAI += `${title}: ${displayNumber}${data.result.karmicDebt ? ` (Dette Karmique ${data.result.karmicDebt})` : ''}\n`;
                        });
                        // Ce prompt est soigneusement conçu pour guider l'IA vers une analyse de haute qualité.
                        // Il définit le rôle, fournit les données structurées et demande une sortie spécifique.
                        const aiPrompt = `# CONTEXTE\nAgis comme un expert en numérologie stratégique. Analyse le thème suivant.\n\n# THÈME NUMÉROLOGIQUE\n${resultsForAI.trim()}\n\n# CYCLES DE VIE\n${JSON.stringify(theme.lifeCycles, null, 2)}\n\n# ÉNERGIES DU NOM (Présence des nombres de 1 à 9)\n${JSON.stringify(theme.energyPresence, null, 2)}\n\n# TA MISSION\nEn te basant sur TOUTES ces données, rédige une analyse complète et bienveillante. Ta valeur est de TISSER DES LIENS entre les nombres pour révéler les synergies, les défis et le potentiel global. Prends en compte la vibration complète des maîtres nombres (ex: la dualité travail/vision du 22/4).\n\nStructure ta réponse ainsi :\n1. **Synthèse Stratégique (Le Duo Clé) :** Explique la dynamique centrale entre le Chemin de Vie (la mission) et le Nombre d'Expression (les outils). Comment ces deux nombres interagissent-ils ? Est-ce une synergie ou un défi de croissance ?\n2. **Forces Principales & Potentiel :** Identifie 2-3 associations positives entre les différents nombres (ex: Âme et Personnalité alignées, énergies dominantes du nom qui soutiennent le Chemin de Vie). Explique comment exploiter ce potentiel.\n3. **Axes de Croissance (Défis & Freins) :** Analyse les tensions, les dettes karmiques et les énergies manquantes du nom. Donne un conseil concret pour transformer chaque défi en une opportunité de croissance.\n4. **Feuille de Route pour la Période Actuelle :** En se basant sur le cycle de vie actuel (considérer que nous sommes en ${new Date().getFullYear()}), quel est le principal conseil pour la période que la personne traverse ?\n5. **Conseil Final :** Résume le potentiel unique de cette personne en une phrase puissante et donne un conseil final actionnable.`;
                        navigator.clipboard.writeText(aiPrompt.trim()).then(() => { 
                            const originalText = this.elements.aiExportBtn.innerHTML; 
                            this.elements.aiExportBtn.innerHTML = '✅ Copié dans le presse-papiers !'; 
                            this.elements.aiExportBtn.disabled = true; 
                            setTimeout(() => { this.elements.aiExportBtn.innerHTML = originalText; this.elements.aiExportBtn.disabled = false; }, 2500); 
                        });
                    };
                }
            };
            // Lance l'initialisation de l'interface utilisateur.
            ui.init();
        });
    </script>
</body>
</html>
